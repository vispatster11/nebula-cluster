---
# Source: wiki-chart/templates/network-policy.yaml
# Default-deny policy for the namespace. This is a best practice.
# It blocks all ingress traffic unless another policy explicitly allows it.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: local-release-wiki-chart-default-deny-ingress
  namespace: local-test
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# Source: wiki-chart/templates/network-policy.yaml
# Specific policy for FastAPI
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: local-release-wiki-chart-fastapi-policy
  namespace: local-test
spec:
  podSelector:
    matchLabels: 
      app: fastapi
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Prometheus for scraping metrics
    - from:
        - podSelector:
            matchLabels: 
              app: prometheus
      ports:
        - protocol: TCP
          port: 8000
    # Allow from the Ingress Controller.
    # These labels should be configured in values.yaml to match your cluster's Ingress Controller.
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: "kube-system"
          podSelector:
            matchLabels:
              app.kubernetes.io/name: "traefik"
      ports:
        - protocol: TCP
          port: 8000
    # Allow from the test job
    - from:
        - podSelector:
            matchLabels: 
              app.kubernetes.io/component: test
      ports:
        - protocol: TCP
          port: 8000
  egress:
    # Allow to Postgres
    - to:
        - podSelector:
            matchLabels: 
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow DNS requests for service discovery
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Source: wiki-chart/templates/network-policy.yaml
# Allow traffic to Postgres from the FastAPI app and test job
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: local-release-wiki-chart-allow-to-postgres
  namespace: local-test
spec:
  podSelector:
    matchLabels: 
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Allow from the FastAPI app
        - podSelector:
            matchLabels: 
              app: fastapi
        # Allow from the test job
        - podSelector:
            matchLabels: 
              app.kubernetes.io/component: test
      ports:
        - protocol: TCP
          port: 5432
---
# Source: wiki-chart/templates/network-policy.yaml
# Allow traffic to Grafana from the Ingress Controller and test job
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: local-release-wiki-chart-allow-to-grafana
  namespace: local-test
spec:
  podSelector:
    matchLabels: 
      app: grafana
  policyTypes:
    - Ingress
  ingress:
    # Allow from the Ingress Controller.
    # These labels should be configured in values.yaml to match your cluster's Ingress Controller.
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: "kube-system"
          podSelector:
            matchLabels:
              app.kubernetes.io/name: "traefik"
      ports:
        - protocol: TCP
          port: 3000
    # Allow from the test job
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: test
      ports:
        - protocol: TCP
          port: 3000
---
# Source: wiki-chart/templates/test-policy.yaml
# test-policy.yaml
# This policy grants the helm test pod the necessary egress permissions
# to connect to the services it needs to test.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: local-release-wiki-chart-test-policy
  namespace: local-test
spec:
  podSelector:
    matchLabels: 
      app.kubernetes.io/component: test
  policyTypes:
    - Egress
  egress:
    # Allow to FastAPI
    - to:
        - podSelector:
            matchLabels: 
              app: fastapi
      ports:
        - protocol: TCP
          port: 8000
    # Allow to Grafana
    - to:
        - podSelector:
            matchLabels: 
              app: grafana
      ports:
        - protocol: TCP
          port: 3000
    # Allow to Prometheus
    - to:
        - podSelector:
            matchLabels: 
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090
    # Allow DNS requests for service discovery
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Source: wiki-chart/templates/pdb-fastapi.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: local-release-wiki-chart-fastapi-pdb
  namespace: local-test
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: wiki-chart
      app.kubernetes.io/instance: local-release
---
# Source: wiki-chart/templates/fastapi-serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-release-wiki-chart-fastapi-sa
  namespace: local-test
  labels:
    app: fastapi
---
# Source: wiki-chart/templates/grafana-secret.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-release-wiki-chart-grafana
  namespace: local-test
---
# Source: wiki-chart/templates/postgres-serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-release-wiki-chart-postgres-sa
  namespace: local-test
  labels:
    app: postgres
---
# Source: wiki-chart/templates/prometheus-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-release-wiki-chart-prometheus
  namespace: local-test
  labels:
    app: prometheus
---
# Source: wiki-chart/templates/test-job.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-release-wiki-chart-test
  namespace: local-test
  labels:
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: test
---
# Source: wiki-chart/templates/grafana-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: local-release-wiki-chart-grafana-secret
type: Opaque
stringData:
  admin-password: admin
---
# Source: wiki-chart/templates/postgres-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: local-release-wiki-chart-postgres-secret
  namespace: local-test
type: Opaque
stringData:
  password: U1tRsWhtOiSrNX1Dl8Y5DNGy4G8K8AJR
---
# Source: wiki-chart/templates/grafana-dashboard-provider.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-grafana-dashboard-provider
  namespace: local-test
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'Wiki Dashboards'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /etc/grafana/provisioning/dashboards
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-grafana-dashboards
  namespace: local-test
data:
  creation-dashboard.json: |
    {
      "dashboard": {
        "title": "creation",
        "uid": "creation-dashboard-678",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Users & Posts Creation Rate",
            "type": "graph",
            "gridPos": {
              "h": 12,
              "w": 24,
              "x": 0,
              "y": 0
            },
            "targets": [
              {
                "expr": "rate(users_created_total[5m])",
                "refId": "A",
                "legendFormat": "Users/sec"
              },
              {
                "expr": "rate(posts_created_total[5m])",
                "refId": "B",
                "legendFormat": "Posts/sec"
              }
            ],
            "yaxes": [
              {
                "format": "short",
                "label": "Rate (per sec)"
              },
              {
                "format": "short",
                "label": ""
              }
            ]
          },
          {
            "id": 2,
            "title": "Total Users Created",
            "type": "stat",
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 0,
              "y": 12
            },
            "targets": [
              {
                "expr": "users_created_total",
                "refId": "A"
              }
            ]
          },
          {
            "id": 3,
            "title": "Total Posts Created",
            "type": "stat",
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 6,
              "y": 12
            },
            "targets": [
              {
                "expr": "posts_created_total",
                "refId": "A"
              }
            ]
          }
        ],
        "refresh": "10s",
        "schemaVersion": 26,
        "version": 0
      },
      "overwrite": true
    }
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-grafana-datasources
  namespace: local-test
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://local-release-wiki-chart-prometheus:9090
      isDefault: true
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-grafana-provisioning
  namespace: local-test
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'Dashboard Provider'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /var/lib/grafana/dashboards
---
# Source: wiki-chart/templates/postgres.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-postgres-config
data:
  POSTGRES_DB: wiki
  POSTGRES_USER: postgres
---
# Source: wiki-chart/templates/prometheus.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-release-wiki-chart-prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    scrape_configs:
      - job_name: 'fastapi'
        static_configs:
          - targets: ['local-release-wiki-chart-fastapi:8000']
        metrics_path: '/metrics'
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-release-wiki-chart-grafana-pvc
  namespace: local-test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-path
---
# Source: wiki-chart/templates/prometheus.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-release-wiki-chart-prometheus-pvc
  namespace: local-test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName:
---
# Source: wiki-chart/templates/prometheus-rbac.yaml
# Namespace-scoped Role for Prometheus (least privilege)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: local-release-wiki-chart-prometheus
  namespace: local-test
rules:
  - apiGroups: [""]
    resources:
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
---
# Source: wiki-chart/templates/prometheus-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: local-release-wiki-chart-prometheus
  namespace: local-test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: local-release-wiki-chart-prometheus
subjects:
  - kind: ServiceAccount
    name: local-release-wiki-chart-prometheus
    namespace: local-test
---
# Source: wiki-chart/templates/fastapi.yaml
apiVersion: v1
kind: Service
metadata:
  name: local-release-wiki-chart-fastapi
  labels:
    app: fastapi
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
  selector:
    app: fastapi
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: v1
kind: Service
metadata:
  name: local-release-wiki-chart-grafana
  namespace: local-test
  labels:
    app: grafana
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
  selector:
    app: grafana
---
# Source: wiki-chart/templates/postgres.yaml
apiVersion: v1
kind: Service
metadata:
  name: local-release-wiki-chart-postgres
  labels:
    app: postgres
spec:
  type: ClusterIP
  clusterIP: None # This makes the service "headless", which is required for a StatefulSet
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app: postgres
---
# Source: wiki-chart/templates/prometheus.yaml
apiVersion: v1
kind: Service
metadata:
  name: local-release-wiki-chart-prometheus
  namespace: local-test
  labels:
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
  - port: 9090
    targetPort: 9090
    protocol: TCP
  selector:
    app: prometheus
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
---
# Source: wiki-chart/templates/fastapi.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: local-release-wiki-chart-fastapi
  labels:
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: wiki-chart
      app.kubernetes.io/instance: local-release
  template:
    metadata:
      labels:
        app: fastapi
        app.kubernetes.io/name: wiki-chart
        app.kubernetes.io/instance: local-release
    spec:
      serviceAccountName: local-release-wiki-chart-fastapi-sa
      initContainers:
      - name: wait-for-postgres
        # use postgres client image to get pg_isready utility
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          until pg_isready -h local-release-wiki-chart-postgres -p 5432 -U postgres; do
            echo "Waiting for Postgres to be ready..."
            sleep 2
          done
      containers:
      - name: fastapi
        image: "wiki-service:local"
        imagePullPolicy: Never
        ports:
        - containerPort: 8000
        env:
        - name: DB_USER
          value: postgres
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: local-release-wiki-chart-postgres-secret
              key: password
        - name: DB_HOST
          value: "local-release-wiki-chart-postgres"
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: wiki
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        securityContext:
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        livenessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 10
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
---
# Source: wiki-chart/templates/grafana.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: local-release-wiki-chart-grafana
  namespace: local-test
  labels:
    app: grafana
    release: local-release
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      serviceAccountName: local-release-wiki-chart-grafana
      securityContext:
        runAsNonRoot: true
        runAsUser: 472
        fsGroup: 472
      containers:
      - name: grafana
        image: "grafana/grafana:9.0.0"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: admin
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: local-release-wiki-chart-grafana-secret
              key: admin-password
        - name: GF_SERVER_ROOT_URL
          value: http://localhost/grafana/
        - name: GF_SERVER_SERVE_FROM_SUB_PATH
          value: "true"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards
          mountPath: /etc/grafana/provisioning/dashboards
        - name: dashboard-files
          mountPath: /var/lib/grafana/dashboards
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
        securityContext:
          runAsNonRoot: true
          runAsUser: 472
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: local-release-wiki-chart-grafana-pvc
      - name: grafana-datasources
        configMap:
          name: local-release-wiki-chart-grafana-datasources
      - name: grafana-dashboards
        configMap:
          name: local-release-wiki-chart-grafana-provisioning
      - name: dashboard-files
        configMap:
          name: local-release-wiki-chart-grafana-dashboards
---
# Source: wiki-chart/templates/prometheus.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: local-release-wiki-chart-prometheus
  namespace: local-test
  labels:
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
      app.kubernetes.io/name: wiki-chart
      app.kubernetes.io/instance: local-release
  template:
    metadata:
      labels:
        app: prometheus
        app.kubernetes.io/name: wiki-chart
        app.kubernetes.io/instance: local-release
    spec:
      serviceAccountName: local-release-wiki-chart-prometheus
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      containers:
      - name: prometheus
        image: "prom/prometheus:v2.48.0"
        imagePullPolicy: IfNotPresent
        args:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--storage.tsdb.retention.time=15d'
        ports:
        - containerPort: 9090
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 512Mi
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus
        - name: prometheus-storage
          mountPath: /prometheus
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: prometheus-config
        configMap:
          name: local-release-wiki-chart-prometheus-config
      - name: prometheus-storage
        persistentVolumeClaim:
          claimName: local-release-wiki-chart-prometheus-pvc
---
# Source: wiki-chart/templates/postgres.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: local-release-wiki-chart-postgres
  labels:
    app: postgres
    release: local-release
spec:
  replicas: 1
  serviceName: local-release-wiki-chart-postgres
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      serviceAccountName: local-release-wiki-chart-postgres-sa
      initContainers:
      - name: set-data-permission
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        - |
          chown -R 70:70 /var/lib/postgresql/data
        securityContext:
          runAsUser: 0 # Run as root to have permission to chown
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
      securityContext:
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70
      containers:
      - name: postgres
        image: "postgres:15-alpine"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5432
        envFrom:
        - configMapRef:
            name: local-release-wiki-chart-postgres-config
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: local-release-wiki-chart-postgres-secret
              key: password
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 10
  volumeClaimTemplates:
    - metadata:
        name: postgres-storage
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
        storageClassName: local-path
---
# Source: wiki-chart/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: local-release-wiki-chart-ingress
  namespace: local-test
spec:
  ingressClassName: traefik
  rules:
  - host: localhost
    http:
      paths:
      # FastAPI endpoints
      - path: /users
        pathType: Prefix
        backend:
          service:
            name: local-release-wiki-chart-fastapi
            port:
              number: 8000
      - path: /posts
        pathType: Prefix
        backend:
          service:
            name: local-release-wiki-chart-fastapi
            port:
              number: 8000
      - path: /user
        pathType: Prefix
        backend:
          service:
            name: local-release-wiki-chart-fastapi
            port:
              number: 8000
      - path: /metrics
        pathType: Exact
        backend:
          service:
            name: local-release-wiki-chart-fastapi
            port:
              number: 8000
      # Root/info endpoint
      - path: /
        pathType: Prefix
        backend:
          service:
            name: local-release-wiki-chart-fastapi
            port:
              number: 8000
      # Grafana endpoint
      - path: /grafana
        pathType: Prefix
        backend:
          service:
            name: local-release-wiki-chart-grafana
            port:
              number: 3000
---
# Source: wiki-chart/templates/test-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: local-release-wiki-chart-test
  annotations:
    "helm.sh/hook": test
  namespace: local-test
  labels:
    helm.sh/chart: wiki-chart-1.0.0
    app.kubernetes.io/name: wiki-chart
    app.kubernetes.io/instance: local-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: test
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: wiki-chart
        app.kubernetes.io/instance: local-release
        app.kubernetes.io/component: test
    spec:
      serviceAccountName: local-release-wiki-chart-test
      restartPolicy: Never
      volumes:
        - name: output-log
          emptyDir: {}
      containers:
      - name: test
        image: curlimages/curl:8.1.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: output-log
            mountPath: /output
        command:
        - /bin/sh
        - -c
        - |
          # Redirect all stdout/stderr to a log file in the writable /output volume
          # while also teeing to the container's stdout for live viewing.
          exec &> >(tee /output/test-run.log)

          set -e
          
          echo "=== Wiki Chart Integration Tests ==="
          echo ""
          
          # Wait for FastAPI service to be ready
          echo "Waiting for FastAPI service to be ready..."
          i=1
          while [ $i -le 30 ]; do
            if curl -s -f --connect-timeout 5 --max-time 10 http://local-release-wiki-chart-fastapi:8000/ > /dev/null 2>&1; then
              echo "✓ FastAPI service is ready"
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 2
            i=$((i+1))
          done
          
          if [ $i -gt 30 ]; then
            echo "✗ Timeout waiting for FastAPI service."
            exit 1
          fi

          BASE_URL="http://local-release-wiki-chart-fastapi:8000"
          
          # Test 1: Root endpoint
          echo ""
          echo "Test 1: GET / (root endpoint)"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "$BASE_URL/")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "User and Post API"; then
            echo "✓ Root endpoint works"
          else
            echo "✗ Root endpoint failed"
            exit 1
          fi
          
          # Test 2: Create user
          echo ""
          echo "Test 2: POST /users (create user)"
          USER_RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 -X POST "$BASE_URL/users" \
            -H "Content-Type: application/json" \
            -d '{"name": "TestUser"}')
          echo "Response: $USER_RESPONSE"
          if echo "$USER_RESPONSE" | grep -q '"id"'; then
            echo "✓ Create user works"
            USER_ID=$(echo "$USER_RESPONSE" | grep -o '"id":[0-9]*' | cut -d':' -f2)
          else
            echo "✗ Create user failed"
            exit 1
          fi
          
          # Test 3: Get user
          echo ""
          echo "Test 3: GET /user/$USER_ID (get user by ID)"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "$BASE_URL/user/$USER_ID")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"name":"TestUser"'; then
            echo "✓ Get user works"
          else
            echo "✗ Get user failed"
            exit 1
          fi
          
          # Test 4: Create post
          echo ""
          echo "Test 4: POST /posts (create post)"
          POST_RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 -X POST "$BASE_URL/posts" \
            -H "Content-Type: application/json" \
            -d '{"user_id": '$USER_ID', "content": "Test post"}')
          echo "Response: $POST_RESPONSE"
          if echo "$POST_RESPONSE" | grep -q '"post_id"'; then
            echo "✓ Create post works"
            POST_ID=$(echo "$POST_RESPONSE" | grep -o '"post_id":[0-9]*' | cut -d':' -f2)
          else
            echo "✗ Create post failed"
            exit 1
          fi
          
          # Test 5: Get post
          echo ""
          echo "Test 5: GET /posts/$POST_ID (get post by ID)"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "$BASE_URL/posts/$POST_ID")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"content":"Test post"'; then
            echo "✓ Get post works"
          else
            echo "✗ Get post failed"
            exit 1
          fi
          
          # Test 6: Metrics endpoint
          echo ""
          echo "Test 6: GET /metrics (Prometheus metrics)"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "$BASE_URL/metrics")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "users_created_total"; then
            echo "✓ Metrics endpoint works"
          else
            echo "✗ Metrics endpoint failed"
            exit 1
          fi
          
          # Test 7: Grafana health endpoint
          echo ""
          echo "Test 7: GET /api/health (Grafana health)"
          GRAFANA_URL="http://local-release-wiki-chart-grafana:3000"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "$GRAFANA_URL/api/health")
          echo "Response: '$RESPONSE'"
          if echo "$RESPONSE" | grep -q '"database": *"ok"'; then
            echo "✓ Grafana health endpoint works"
          else
            echo "✗ Grafana health endpoint failed"
            exit 1
          fi

          # Test 8: Prometheus health endpoint
          echo ""
          echo "Test 8: GET /-/healthy (Prometheus health)"
          PROMETHEUS_URL="http://local-release-wiki-chart-prometheus:9090"
          echo "Connecting to Prometheus at: $PROMETHEUS_URL"
          RESPONSE=$(curl -v --connect-timeout 5 --max-time 10 "$PROMETHEUS_URL/-/healthy" 2>&1)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -qE "(Prometheus|healthy|200 OK)"; then
            echo "✓ Prometheus health endpoint works"
          else
            echo "✗ Prometheus health endpoint failed"
            echo "Debugging info: Attempting to check if Prometheus pod is running..."
            exit 1
          fi

          echo ""
          echo "=== All tests passed ==="
        resources:
          requests:
            cpu: 100m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
