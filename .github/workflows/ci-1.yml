name: Main CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  python-quality:
    name: 1. Python Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r wiki-service/requirements.txt
          pip install bandit black ruff

      - name: Run Black Formatter
        run: black --check wiki-service/

      - name: Run Ruff Linter
        run: ruff check wiki-service/

      - name: Run Bandit Security Scanner
        run: bandit -r wiki-service/

  image-scan:
    name: 2. Docker Image Security Scan
    runs-on: ubuntu-latest
    needs: python-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t wiki-service:ci-scan wiki-service/

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wiki-service:ci-scan'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  helm-lint:
    name: 3. Helm Chart Validation
    runs-on: ubuntu-latest
    needs: python-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.2'

      - name: Run Helm lint
        run: helm lint ./wiki-chart --strict

  integration-test:
    name: 4. Integration Tests (k3d)
    runs-on: ubuntu-latest
    needs: [image-scan, helm-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create k3d cluster
        uses: k3d-io/k3d-action@v2.1.0
        with:
          cluster-name: 'ci-cluster'
          args: '--image rancher/k3s:v1.29.4-k3s1'

      - name: Build and import image into k3d
        run: |
          docker build -t wiki-service:ci-test wiki-service/
          k3d image import wiki-service:ci-test -c ci-test-cluster

      - name: Install Helm chart
        run: |
          helm install ci-release ./wiki-chart \
            --namespace default \
            --set fastapi.image.tag=ci-test \
            --set fastapi.image.pullPolicy=Never \
            --wait --timeout 5m

      - name: Verify deployment
        run: |
          echo "--- Verifying Pods ---"
          kubectl get pods
          kubectl wait --for=condition=Ready pod --all --timeout=2m

          echo "--- Verifying Services ---"
          kubectl get svc

          echo "--- Testing API endpoint ---"
          kubectl port-forward svc/ci-release-wiki-chart-fastapi 8080:8000 &
          sleep 5 # Wait for port-forward to establish
          for i in {1..10}; do
            if curl -f http://localhost:8080/users -X POST -H "Content-Type: application/json" -d '{"name": "testuser"}'; then
              echo "API test successful."
              break
            fi
            echo "API test failed, retrying in 5s..."
            sleep 5
          done
