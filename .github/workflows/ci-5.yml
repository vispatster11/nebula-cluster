name: CI-5 Integration Test

on:
  workflow_dispatch:
  push:
    paths:
      - 'wiki-service/**'
      - 'wiki-chart/**'
      - '.github/workflows/ci-5.yml'

jobs:
  integration-test:
    name: Run k3d Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create k3d cluster
        uses: k3d-io/k3d-action@v2.1.0
        with:
          cluster-name: 'ci-test-cluster'
          args: '--image rancher/k3s:v1.28.8-k3s1'

      - name: Build and import image into k3d
        run: |
          docker build -t wiki-service:ci-test wiki-service/
          k3d image import wiki-service:ci-test -c ci-test-cluster

      - name: Deploy Helm chart
        run: |
          helm install ci-release ./wiki-chart \
            --namespace default \
            --set fastapi.image.tag=ci-test \
            --set fastapi.image.pullPolicy=Never \
            --set grafana.adminPassword=admin \
            --wait --timeout 5m

      - name: Check deployment status
        run: |
          echo "--- Verifying Pods ---"
          kubectl get pods
          kubectl wait --for=condition=Ready pod --all --timeout=2m
          echo "--- Verifying Services ---"
          kubectl get svc
          echo "--- Testing API endpoint ---"
          kubectl port-forward svc/ci-release-wiki-chart-fastapi 8080:8000 &
          for i in {1..10}; do
            if curl -f http://localhost:8080/users -X POST -H "Content-Type: application/json" -d '{"name": "testuser"}'; then
              break
            fi
            echo "API test failed, retrying in 5s..."
            sleep 5
          done