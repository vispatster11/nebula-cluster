name: CI Pipeline - Build, Test, Scan & Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'wiki-service/**'
      - 'wiki-chart/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: wiki
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # Using a more common, stable version

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r wiki-service/requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Wait for PostgreSQL to be ready
        run: |
          sudo apt-get update && sudo apt-get install -y netcat
          until nc -z 127.0.0.1 5432; do
            echo "Waiting for PostgreSQL..."
            sleep 1
          done

      - name: Run tests
        env:
          DB_USER: postgres
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_NAME: wiki
        run: |
          pytest -v --tb=short wiki-service/

      - name: Build and save Docker image
        run: |
          docker build -t wiki-service:ci wiki-service/
          docker save wiki-service:ci -o wiki-service.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wiki-service-image
          path: wiki-service.tar

  scan-image:
    runs-on: ubuntu-latest
    name: Scan Docker Image
    needs: [build-and-test]

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wiki-service-image

      - name: Load Docker image
        run: docker load -i wiki-service.tar

      - name: Install Trivy and scan image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'wiki-service:ci'
          format: 'table'
          exit-code: '1' # Fail on critical/high vulnerabilities
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  helm-integration:
    runs-on: ubuntu-latest
    needs: [scan-image]
    name: Helm Chart Integration (k3d simulation)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wiki-service-image

      - name: Load Docker image
        run: docker load -i wiki-service.tar

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: k3d cluster create test-wiki --wait

      - name: Import FastAPI image into k3d
        run: k3d image import wiki-service:ci -c test-wiki

      - name: Deploy Helm chart
        run: |
          kubectl create namespace wiki-app
          helm install test-wiki ./wiki-chart \
            --namespace wiki-app \
            --set fastapi.image.repository=wiki-service \
            --set fastapi.image.tag=ci \
            --set fastapi.image.pullPolicy=Never \
            --set grafana.adminPassword=admin \
            --wait --timeout 5m

      - name: Check deployment status
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n wiki-app

          echo "=== Service Status ==="
          kubectl get svc -n wiki-app

          echo "=== Deployment Logs (FastAPI) ==="
          # Use the correct label 'app: fastapi' from the Helm template
          kubectl logs -n wiki-app -l app=fastapi --tail=50

      - name: Wait for pods and run tests
        run: |
          echo "Waiting for pods to be ready (timeout: 120s)..."
          # Use the correct label 'app: fastapi' to wait for the pod
          kubectl wait --for=condition=ready pod -n wiki-app -l app=fastapi --timeout=120s

          echo "=== Helm Test Job Status ==="
          # Wait for the Helm test job to complete
          kubectl wait --for=condition=complete job/test-wiki-test -n wiki-app --timeout=60s

          echo "=== Helm Test Job Logs ==="
          kubectl logs job/test-wiki-test -n wiki-app --tail=100

      - name: Test FastAPI endpoints via port-forward
        run: |
          echo "=== Testing FastAPI Application ==="

          # Start port-forward in the background
          kubectl port-forward -n wiki-app svc/test-wiki-fastapi 8080:80 &
          FORWARD_PID=$!
          sleep 5 # Allow time for port-forward to establish

          # Health check
          echo "Testing GET / (root endpoint)"
          curl -s -i http://localhost:8080/ || echo "Root endpoint check failed"

          # Create user
          echo ""
          echo "Testing POST /users (create user)"
          USER_RESPONSE=$(curl -s -X POST http://localhost:8080/users \
            -H "Content-Type: application/json" \
            -d '{"name":"K8s Test User"}')
          echo "$USER_RESPONSE"

          # Get user
          echo ""
          echo "Testing GET /users/1 (retrieve user)"
          curl -s http://localhost:8080/users/1 || echo "Get user failed"

          # Create post
          echo ""
          echo "Testing POST /posts (create post)"
          POST_RESPONSE=$(curl -s -X POST http://localhost:8080/posts \
            -H "Content-Type: application/json" \
            -d '{"user_id":1,"content":"Kubernetes test post"}')
          echo "$POST_RESPONSE"

          # Get post
          echo ""
          echo "Testing GET /posts/1 (retrieve post)"
          curl -s http://localhost:8080/posts/1 || echo "Get post failed"

          # Metrics endpoint
          echo ""
          echo "Testing GET /metrics (Prometheus metrics)"
          curl -s http://localhost:8080/metrics | head -30 || echo "Metrics endpoint failed"

          # Cleanup port-forward
          kill $FORWARD_PID

      - name: Test Grafana dashboard access
        run: |
          echo "=== Testing Grafana Dashboard ==="

          # Port-forward to Grafana
          kubectl port-forward -n wiki-app svc/test-wiki-grafana 3000:80 &
          FORWARD_PID=$!
          sleep 3

          # Check Grafana health
          echo "Testing Grafana HTTP status:"
          curl -s -i http://localhost:3000/api/health || echo "Grafana health check failed"

          echo ""
          echo "Testing Grafana dashboard availability:"
          curl -s -i http://localhost:3000/d/creation-dashboard-678/creation || echo "Dashboard endpoint failed"

          echo ""
          echo "Checking for Prometheus datasource:"
          curl -s http://localhost:3000/api/datasources || echo "Datasources check failed"

          # Cleanup port-forward
          kill $FORWARD_PID

      - name: Cleanup k3d cluster
        if: always()
        run: k3d cluster delete test-wiki

  summary:
    runs-on: ubuntu-latest
    name: Test Summary
    needs: [build-and-test, scan-image, helm-integration]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "=== Integration Test Summary ==="
          echo "✓ Build and Test job status: ${{ needs.build-and-test.result }}"
          echo "✓ Image Scan job status: ${{ needs.scan-image.result }}"
          echo "✓ Helm Integration job status: ${{ needs.helm-integration.result }}"
          echo ""
          echo "Check individual job logs for detailed results."
