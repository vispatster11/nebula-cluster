name: CI Pipeline - Build, Test, Scan & Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'wiki-service/**'
      - 'wiki-chart/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: wiki
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r wiki-service/requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Wait for PostgreSQL to be ready
        run: |
          sudo apt-get update && sudo apt-get install -y netcat-openbsd
          until nc -z 127.0.0.1 5432; do
            echo "Waiting for PostgreSQL..."
            sleep 1
          done

      - name: Run tests
        env:
          DB_USER: postgres
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_NAME: wiki
        run: |
          pytest -v --tb=short wiki-service/ || echo "Tests completed with status: $?"

      - name: Build and save Docker image
        run: |
          docker build -t wiki-service:ci wiki-service/
          docker save wiki-service:ci -o wiki-service.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wiki-service-image
          path: wiki-service.tar

  scan-image:
    runs-on: ubuntu-latest
    name: Scan Docker Image
    needs: [build-and-test]

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wiki-service-image

      - name: Load Docker image
        run: docker load -i wiki-service.tar

      - name: Install Trivy and scan image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'wiki-service:ci'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          timeout: '10m'

  helm-integration:
    runs-on: ubuntu-latest
    needs: [scan-image]
    name: Helm Chart Integration (k3d simulation)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wiki-service-image

      - name: Load Docker image
        run: docker load -i wiki-service.tar

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create test-wiki --image rancher/k3s:v1.31.13-k3s1 --wait || true
          kubectl config use-context k3d-test-wiki || true

      - name: Import FastAPI image into k3d
        run: k3d image import wiki-service:ci -c test-wiki

      - name: Deploy Helm chart
        run: |
          kubectl create namespace wiki-test || true
          kubectl config set-context --current --namespace=wiki-test
          helm install test-wiki ./wiki-chart \
            --namespace wiki-test \
            --set fastapi.image.tag=ci \
            --set fastapi.image.pullPolicy=Never \
            --set grafana.adminPassword=admin \
            --wait --timeout 5m || true

      - name: Check deployment status
        run: |
          echo "Pod Status"
          kubectl get pods -n wiki-test
          echo "Service Status"
          kubectl get svc -n wiki-test
          echo "Deployment Logs"
          kubectl logs -n wiki-test -l app.kubernetes.io/instance=test-wiki --tail=50

      - name: Wait for pods and run tests
        continue-on-error: true
        run: |
          echo "Waiting for pods to be ready"
          kubectl wait --for=condition=ready pod -n wiki-test -l app.kubernetes.io/instance=test-wiki --timeout=120s || true
          echo "Helm Test Job Status"
          kubectl wait --for=condition=complete job/test-wiki-test -n wiki-test --timeout=60s || true
          echo "Helm Test Job Logs"
          kubectl logs job/test-wiki-test -n wiki-test --tail=100 || true

      - name: Test FastAPI endpoints via port-forward
        continue-on-error: true
        run: |
          echo "Testing FastAPI Application"
          kubectl port-forward -n wiki-test svc/test-wiki-fastapi 8080:80 &
          FORWARD_PID=$!
          sleep 5
          curl -s -i http://localhost:8080/ --max-time 5 || true
          echo "Testing user creation"
          curl -s -X POST http://localhost:8080/users -H "Content-Type: application/json" -d '{"name":"K8s Test User"}' --max-time 5 || true
          kill -9 $FORWARD_PID 2>/dev/null || true

      - name: Test Grafana dashboard access
        continue-on-error: true
        run: |
          echo "Testing Grafana Dashboard"
          kubectl port-forward -n wiki-test svc/test-wiki-grafana 3000:80 &
          FORWARD_PID=$!
          sleep 3
          curl -s -i http://localhost:3000/api/health --max-time 5 || true
          kill -9 $FORWARD_PID 2>/dev/null || true

      - name: Cleanup k3d cluster
        if: always()
        continue-on-error: true
        run: k3d cluster delete test-wiki || true

  summary:
    runs-on: ubuntu-latest
    name: Test Summary
    needs: [build-and-test, scan-image, helm-integration]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "Integration Test Summary"
          echo "Build and Test job status: ${{ needs.build-and-test.result }}"
          echo "Image Scan job status: ${{ needs.scan-image.result }}"
          echo "Helm Integration job status: ${{ needs.helm-integration.result }}"
