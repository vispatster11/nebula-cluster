name: Helm Chart Validation

on:
  push:
    branches:
      - main
    paths:
      - 'wiki-chart/**'
      - '.github/workflows/helm-lint.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'wiki-chart/**'
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint and Validate Helm Chart
    needs: []
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Lint Helm chart
        run: helm lint wiki-chart --strict

      - name: Validate Helm chart template
        run: helm template wiki wiki-chart

      - name: Check for required resources
        run: |
          output=$(helm template wiki wiki-chart)
          
          # Check for required Deployments
          echo "Checking for Deployments..."
          echo "$output" | grep -q 'kind: Deployment' && echo "✓ Deployment found" || exit 1
          
          # Check for required Services
          echo "Checking for Services..."
          echo "$output" | grep -q 'kind: Service' && echo "✓ Service found" || exit 1
          
          # Check for required Secrets
          echo "Checking for Secrets..."
          echo "$output" | grep -q 'kind: Secret' && echo "✓ Secret found" || exit 1
          
          # Check for required ConfigMaps
          echo "Checking for ConfigMaps..."
          echo "$output" | grep -q 'kind: ConfigMap' && echo "✓ ConfigMap found" || exit 1
          
          # Check for Ingress
          echo "Checking for Ingress..."
          echo "$output" | grep -q 'kind: Ingress' && echo "✓ Ingress found" || exit 1
          
          # Check for NetworkPolicy
          echo "Checking for NetworkPolicy..."
          echo "$output" | grep -q 'kind: NetworkPolicy' && echo "✓ NetworkPolicy found" || exit 1
          
          # Check for PodDisruptionBudget
          echo "Checking for PodDisruptionBudget..."
          echo "$output" | grep -q 'kind: PodDisruptionBudget' && echo "✓ PodDisruptionBudget found" || exit 1
          
          # Check for Job (test)
          echo "Checking for Job..."
          echo "$output" | grep -q 'kind: Job' && echo "✓ Job found" || exit 1

      - name: Verify security contexts
        run: |
          output=$(helm template wiki wiki-chart)
          
          echo "Checking for non-root security contexts..."
          # Check for runAsNonRoot in FastAPI
          if echo "$output" | grep -A 20 'name: fastapi' | grep -q 'runAsNonRoot: true'; then
            echo "✓ FastAPI runs as non-root"
          else
            echo "⚠ Warning: FastAPI may not explicitly set runAsNonRoot"
          fi
          
          # Check for dropped capabilities
          if echo "$output" | grep -q 'DROP'; then
            echo "✓ Found capability dropping in securityContext"
          else
            echo "⚠ Warning: No capability dropping found"
          fi

      - name: Display full template output
        if: always()
        run: helm template wiki wiki-chart

  integration-test:
    runs-on: ubuntu-latest
    name: Integration Test (if cluster available)
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Run Helm validation scripts
        run: |
          chmod +x tests/helm-validate.sh
          ./tests/helm-validate.sh
