apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "wiki-chart.fullname" . }}-test
  annotations:
    "helm.sh/hook": test
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wiki-chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        {{- include "wiki-chart.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: test
    spec:
      serviceAccountName: {{ include "wiki-chart.fullname" . }}-test
      restartPolicy: Never
      containers:
      - name: test
        image: curlimages/curl:8.1.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "=== Wiki Chart Integration Tests ==="
          echo ""
          
          # Wait for FastAPI service to be ready
          echo "Waiting for FastAPI service to be ready..."
          i=1
          while [ $i -le 30 ]; do
            if curl -s -f --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} http://{{ include "wiki-chart.fullname" . }}-fastapi:{{ .Values.fastapi.port }}/ > /dev/null 2>&1; then
              echo "✓ FastAPI service is ready"
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 2
            i=$((i+1))
          done
          
          if [ $i -gt 30 ]; then
            echo "✗ Timeout waiting for FastAPI service."
            exit 1
          fi

          BASE_URL="http://{{ include "wiki-chart.fullname" . }}-fastapi:{{ .Values.fastapi.port }}"
          
          # Test 1: Root endpoint
          echo ""
          echo "Test 1: GET / (root endpoint)"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$BASE_URL/")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "User and Post API"; then
            echo "✓ Root endpoint works"
          else
            echo "✗ Root endpoint failed"
            exit 1
          fi
          
          # Test 2: Create user
          echo ""
          echo "Test 2: POST /users (create user)"
          USER_RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} -X POST "$BASE_URL/users" \
            -H "Content-Type: application/json" \
            -d '{"name": "TestUser"}')
          echo "Response: $USER_RESPONSE"
          if echo "$USER_RESPONSE" | grep -q '"id"'; then
            echo "✓ Create user works"
            USER_ID=$(echo "$USER_RESPONSE" | grep -o '"id":[0-9]*' | cut -d':' -f2)
          else
            echo "✗ Create user failed"
            exit 1
          fi
          
          # Test 3: Get user
          echo ""
          echo "Test 3: GET /user/$USER_ID (get user by ID)"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$BASE_URL/user/$USER_ID")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"name":"TestUser"'; then
            echo "✓ Get user works"
          else
            echo "✗ Get user failed"
            exit 1
          fi
          
          # Test 4: Create post
          echo ""
          echo "Test 4: POST /posts (create post)"
          POST_RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} -X POST "$BASE_URL/posts" \
            -H "Content-Type: application/json" \
            -d '{"user_id": '$USER_ID', "content": "Test post"}')
          echo "Response: $POST_RESPONSE"
          if echo "$POST_RESPONSE" | grep -q '"post_id"'; then
            echo "✓ Create post works"
            POST_ID=$(echo "$POST_RESPONSE" | grep -o '"post_id":[0-9]*' | cut -d':' -f2)
          else
            echo "✗ Create post failed"
            exit 1
          fi
          
          # Test 5: Get post
          echo ""
          echo "Test 5: GET /posts/$POST_ID (get post by ID)"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$BASE_URL/posts/$POST_ID")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"content":"Test post"'; then
            echo "✓ Get post works"
          else
            echo "✗ Get post failed"
            exit 1
          fi
          
          # Test 6: Metrics endpoint
          echo ""
          echo "Test 6: GET /metrics (Prometheus metrics)"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$BASE_URL/metrics")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "users_created_total"; then
            echo "✓ Metrics endpoint works"
          else
            echo "✗ Metrics endpoint failed"
            exit 1
          fi
          
          # Test 7: Grafana health endpoint
          echo ""
          echo "Test 7: GET /api/health (Grafana health)"
          GRAFANA_URL="http://{{ include "wiki-chart.fullname" . }}-grafana:{{ .Values.grafana.port }}"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$GRAFANA_URL/api/health")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"database":"ok"'; then
            echo "✓ Grafana health endpoint works"
          else
            echo "✗ Grafana health endpoint failed"
            exit 1
          fi

          # Test 8: Prometheus health endpoint
          echo ""
          echo "Test 8: GET /-/healthy (Prometheus health)"
          PROMETHEUS_URL="http://{{ include "wiki-chart.fullname" . }}-prometheus:{{ .Values.prometheus.port }}"
          RESPONSE=$(curl -s --connect-timeout {{ .Values.test.curl.connectTimeout }} --max-time {{ .Values.test.curl.maxTime }} "$PROMETHEUS_URL/-/healthy")
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "Prometheus is Healthy."; then
            echo "✓ Prometheus health endpoint works"
          else
            echo "✗ Prometheus health endpoint failed"
            exit 1
          fi

          echo ""
          echo "=== All tests passed ==="
        resources:
          requests:
            cpu: 100m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "wiki-chart.fullname" . }}-test
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wiki-chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
